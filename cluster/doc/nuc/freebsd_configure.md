Name
====

**setup** - setup FreeBSD

Bootstrap
=========

Disable boot menu to speed up restarts:

```console
# echo 'autoboot_delay="0"' >> /boot/loader.conf
```

Use default pkg(8) repositories, configured in /etc/pkg/FreeBSD.conf:

```console
% pkg repos -l
FreeBSD-ports
FreeBSD-ports-kmods
FreeBSD-base
```

The main system will host jails to emulate virtual machines with infrastructure and development environment. As such, it will include include minimal configuration based on quarterly software updates:

```console
% pkg repos FreeBSD-ports
FreeBSD-ports: {
    url             : "pkg+https://pkg.FreeBSD.org/FreeBSD:15:amd64/quarterly",
    enabled         : yes,
    priority        : 0,
    mirror_type     : "SRV",
    signature_type  : "FINGERPRINTS",
    fingerprints    : "/usr/share/keys/pkg"
  }
```

Change root-user shell to tcsh(1):

```console
# chsh -s /bin/tcsh root
```

Resource configuration
----------------------

Goal: move service configuration flags from `/etc/rc.conf` to per-service config to isolate the flags (see [rc](./rc.md)).

**Background**: use `sysrc -s <service> -l` to get a list of configuration files:

```console
% sysrc -s sshd -l
/etc/rc.conf /etc/rc.conf.local /etc/rc.conf.d/sshd /usr/local/etc/rc.conf.d/sshd
```

When moving a flag, first add it to the new location, then remove it from `/etc/rc.conf`:

```console
# sysrc -f /etc/rc.conf.d/sshd sshd_enable=yes
sshd_enable: no -> yes
# sysrc -x sshd_enable
```

Per-service configurations:

```console
% tail -n +1 /etc/rc.conf.d/*
==> /etc/rc.conf.d/hostname <==
hostname="nuc.lab.net"

==> /etc/rc.conf.d/moused <==
moused_nondefault_enable="no"

==> /etc/rc.conf.d/network <==
ifconfig_igc0_ipv6="inet6 accept_rtadv"
ifconfig_igc0="DHCP"

==> /etc/rc.conf.d/ntpd <==
ntpd_enable="yes"
ntpd_sync_on_start="yes"

==> /etc/rc.conf.d/powerd <==
powerd_enable="yes"

==> /etc/rc.conf.d/routing <==
defaultrouter="192.168.1.1"

==> /etc/rc.conf.d/sshd <==
sshd_enable="yes"

==> /etc/rc.conf.d/syslogd <==
syslogd_flags="-ss"

==> /etc/rc.conf.d/zfs <==
zfs_enable="yes"
```

Left overs in `/etc/rc.conf`:

```console
% sysrc -a
clear_tmp_enable: YES
dumpdev: AUTO
```

Services
========

Network time protocol (NTP)
---------------------------

Limit open ports by ntpd:

```console
% tail -n 3 /etc/ntp.conf
interface ignore wildcard
interface listen 127.0.0.1
interface listen igc0
```

Restart the service and verify open ports:

```console
% doas service ntpd restart
% doas sockstat -l4 | grep ntp
ntpd     ntpd       30027 20  udp4   192.168.1.102:123     *:*
ntpd     ntpd       30027 22  udp4   127.0.0.1:123         *:*
```

Packet filter (firewall)
------------------------

Use pf(4) to filter network traffic along with pflog(4) to access logs:

```console
% tail -n +1 /etc/rc.conf.d/pf*
==> /etc/rc.conf.d/pf <==
pf_enable="yes"

==> /etc/rc.conf.d/pflog <==
pflog_enable="yes"
```

pf(4) does not start without a configuration file even though it was enabled.

There are many helpful examples of basic pf(4) configuration available in `/usr/shared/examples/pf`. A minimal setup might be:

```
ext_if = "igc0"
int_if = "bridge1"

tcp_services = "{ domain, http, https, ntp, ssh }"
udp_services = "{ domain, ntp }"

icmp_types = "{ echoreq, unreach }"

# deny all incoming traffic
block in all

# allow connections created by the system, retain the state.
pass out proto tcp to any port $tcp_services keep state
pass proto udp to any port $udp_services keep state

# debugging traffic
pass inet proto icmp all icmp-type $icmp_types keep state

# ssh
pass in inet proto tcp to $ext_if port ssh
pass in inet proto tcp to $int_if port ssh
```

Use pfctl(8) to manage PF:

```
pfctl -e                           # enable PF
pfctl -d                           # disable PF
pfctl -F all -f /etc/pf.conf       # flush NAT, filter, state, table rules, reload /etc/pf.conf
pfctl -s [ rules | nat | states ]  # report on filter rules, NAT rules, state tables
pfctl -si                          # report stats
pfctl -vn -f /etc/pf.conf          # check /etc/pf.conf for errors, do not load ruleset
```

Monitor traffic with pftop(1).

Routing
-------

The resolvconf(8) service manages `/etc/resolv.conf`, automatically created for DHCP networks. It picks up `deafultgateway` from the `routing` service.

Verity the configuration:

```console
% cat /etc/resolv.conf
# Generated by resolvconf
search localdomain
nameserver 192.168.1.1
```

Use drill(1) to test DNS forward and backward resolutions:

```console
% drill freebsd.org
;; ->>HEADER<<- opcode: QUERY, rcode: NOERROR, id: 24872
;; flags: qr rd ra ; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0
;; QUESTION SECTION:
;; freebsd.org. IN  A

;; ANSWER SECTION:
freebsd.org.    3203INA96.47.72.84

;; AUTHORITY SECTION:

;; ADDITIONAL SECTION:

;; Query time: 2 msec
;; SERVER: 192.168.1.1
;; WHEN: Fri Nov 14 12:07:22 2025
;; MSG SIZE  rcvd: 45
% drill -x 96.47.72.84
;; ->>HEADER<<- opcode: QUERY, rcode: NOERROR, id: 12057
;; flags: qr rd ra ; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0
;; QUESTION SECTION:
;; 84.72.47.96.in-addr.arpa.    IN  PTR

;; ANSWER SECTION:
84.72.47.96.in-addr.arpa.   3187    IN  PTR wfe0.nyi.freebsd.org.

;; AUTHORITY SECTION:

;; ADDITIONAL SECTION:

;; Query time: 2 msec
;; SERVER: 192.168.1.1
;; WHEN: Fri Nov 14 12:07:38 2025
;; MSG SIZE  rcvd: 76
```

Secure Shell
------------

Configure SSH to listen on the host IPs and restrict users access:

```console
# fetch -o /tmp https://github.com/skhal/lab/raw/refs/heads/main/cluster/doc/nuc/data/sshd_config.diff
# patch -lb -i /tmp/sshd_config.diff /etc/ssh/sshd_config
```

```console
% cat /etc/rc.conf.d/sshd
sshd_enable="yes"
```

Restart the service and verify work:

```
% doas sockstat -l4 | grep sshd
root     sshd       39929 7   tcp4   192.168.1.102:22      *:*
```

Syslog
------

Make sure Syslog does not open a network port, `-ss` flag should be present in the service RC-script:

```console
% cat /etc/rc.conf.d/syslogd
syslogd_flags="-ss"
```

Verify:

```
% doas sockstat -l4 | grep syslog
```

FreeBSD comes with logs rotation service newsyslog(8) enabled by default:

```console
% sysrc -A | grep newsyslog
newsyslog_enable: YES
newsyslog_flags: -CN
```

The default configuration `-CN` only forces newsyslog(8) to create missing log files. Use crontab(1) to rotate files every hour and use datetime instead of numeric suffix with `crontab -e`:

```console
# crontab -l
SHELL=/bin/sh
PATH=/sbin:/bin:/usr/sbin:/usr/bin

# Fields order
# minute hour mday month wday command

# Rotate log files every hour, if necessary
0 * * * * newsyslog -t DEFAULT
```

### Compression

newsyslog(8) uses bzip2(1) compression by default, newsyslog.conf(5). Notice "J" in the flags column of `/etc/newsyslog.conf`. This compression runs in the user land.

When setup with ZFS, FreeBSD configures ZFS to also use compression:

```console
% zfs get compression zroot/var/log
NAME           PROPERTY     VALUE           SOURCE
zroot/var/log  compression  lz4             inherited from zroot
```

In fact, this compression applies to all datasets under `zroot`. Check the compression efficiency after running the system for a while to let log files grow:

```console
% zfs get used,refcompressratio /var/log
NAME           PROPERTY          VALUE     SOURCE
zroot/var/log  used              292K      -
zroot/var/log  refcompressratio  3.61x     -
```

Given this setup, It is optional to disable compression all together in newsyslog(8) and let ZFS compress the logs including rotated files to save resources. However, copying the rotated file over the network may be inefficient unless one first compresses the file.

### Console logging

`rc(8)` scripts log messages using `logger(1)`, backed to `syslog(3)`. This writes messages to console and any other sinks configured in `systlogd(8)`. Unfortunately, `syslogd(8)` starts at some later stage in `rc(8)` sequence:

```console
% rcorder -p | cat -n | grep -C 1 syslogd
    29	/etc/rc.d/accounting /etc/rc.d/cleartmp /etc/rc.d/devfs /etc/rc.d/dmesg /etc/rc.d/gptboot /etc/rc.d/hostapd /etc/rc.d/mdconfig2 /etc/rc.d/motd /etc/rc.d/newsyslog /etc/rc.d/os-release /etc/rc.d/virecover /etc/rc.d/wpa_supplicant
    30	/etc/rc.d/syslogd
    31	/etc/rc.d/auditd /etc/rc.d/bsnmpd /etc/rc.d/hastd /etc/rc.d/ntpdate /etc/rc.d/power_profile /etc/rc.d/pwcheck /etc/rc.d/savecore /etc/rc.d/watchdogd
```

In result, rc-messages prior to `syslogd(8)` are only available in console. The first ones are from `auditd` service in `/var/log/messages`:

```
Aug 29 14:40:08 nuc kernel: em0: link state changed to UP
Aug 29 14:40:08 nuc root[26487]: /etc/rc: DEBUG: checkyesno: auditd_enable is set to NO.
```

Configure `syslog(3)` to log all console messages:

```console
% grep console.info /etc/syslog.conf
console.info					/var/log/console.log
```

Applications
============

Installed packages:

```console
% pkg prime-list
FreeBSD-kernel-generic
FreeBSD-set-base
FreeBSD-set-lib32
FreeBSD-set-minimal
doas
pftop
pkg
vim-tiny
```

Doas
----

Give the system operator permissions to run basic tools. Everything else is to be managed by root:

```console
# pkg install doas
% cat /usr/local/etc/doas.conf
permit nopass op cmd pftop
permit nopass op cmd pkg
permit nopass op cmd service
permit nopass op cmd shutdown
permit nopass op cmd sockstat
permit nopass op cmd sysrc
permit nopass op cmd top
```

Packages
--------

Add pkg(8) alias to list vital packages that are note removed with `pkg delete -a` ([ref](https://github.com/freebsd/pkg/issues/2485)\):

```fetch
# fetch -o /tmp https://github.com/skhal/lab/raw/refs/heads/main/cluster/doc/nuc/data/pkg.conf.diff
# patch -lb -i /tmp/pkg.conf.diff /usr/local/etc/pkg.conf
```

Smart Monitoring tools
----------------------

```console
# pkg install sensors smartmontools
```

-	`sensors` prints summary of the fan, temperature, and other sensors available on the host.
-	`smartmontools` provides `smartctl` utility to check SMART data from drives. It includes a daemon `smartd` to run checks and a periodic(8) script to collect data.

Configure and start smartd(8) daemon:

```console
# mkdir -v /usr/local/etc/rc.conf.d
# sysrc -f /usr/local/etc/rc.conf.d/smartd smartd_enable=yes
# cp /usr/local/etc/smartd.conf{.sample,}
# service smartd start
```

Verify - force daemon to run checks:

```console
# ps -Ao pid,comm | grep smartd
12345 smartd
# kill -s USR1 12345
# grep smartd /var/log/daemon.log | tail -n 5
```

Let periodic(8) run daily checks and mail the output to the root user:

```console
# cat <<EOF >>/usr/local/etc/periodic.conf
daily_status_smart_enable=yes
daily_status_smart_devices=auto
```
