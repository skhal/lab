Name
====

**setup-server** - local authoritative DNS server

Install
=======

```console
# pkg install bind920
# pkg info -D bind920
bind920-9.20.16:
On install:
BIND requires configuration of rndc, including a "secret"
key.  The easiest, and most secure way to configure rndc is
to run 'rndc-confgen -a' to generate the proper conf file,
with a new random key, and appropriate file permissions.

The /usr/local/etc/rc.d/named script will do that for you.

If using syslog to log the BIND9 activity, and using a
chroot'ed installation, you will need to tell syslog to install
a log socket in the BIND9 chroot by running:

  # sysrc altlog_proglist+=named

And then restarting syslogd with: service syslogd restart
```

Enable the service:

```console
# mkdir /usr/local/etc/rc.conf.d
# sysrc -f /usr/local/etc/rc.conf.d/named named_enable=yes
named_enable:  -> yes
```

Configure
=========

Make following changes to DNS server configuration ([named.conf.diff](./named.conf.diff)\):

-	Listen on local address only (use Jail internal network).
-	Restrict DNS clients to local network.
-	Do no use slave DNS servers.
-	Forward unknown DNS queries to default gateway.
-	Store zone information in `zones.conf.d` folder.

Patch the configuration file:

```console
# fetch -o /tmp https://github.com/skhal/lab/raw/refs/heads/main/cluster/doc/dns/server/named.conf.diff
# patch /usr/local/etc/namedb/named.conf < /tmp/named.conf.diff
```

Configure resolver to use local DNS server:

```console
# cat /etc/resolv.conf
# Generated by resolvconf
search lab.net
nameserver 127.0.0.1
```

Zone lab.net
------------

Store zones in `zones.conf.d` folder:

```console
# mkdir /usr/local/etc/namedb/zones.conf.d
# fetch -o /usr/local/etc/namedb/zones.conf.d https://github.com/skhal/lab/raw/refs/heads/main/cluster/doc/dns/server/zones.conf.d/lab.net.conf
```

Add forward and reverse mappings:

```console
# fetch -o /usr/local/etc/namedb/primary https://github.com/skhal/lab/raw/refs/heads/main/cluster/doc/dns/server/primary/lab.net-forward.db
# fetch -o /usr/local/etc/namedb/primary https://github.com/skhal/lab/raw/refs/heads/main/cluster/doc/dns/server/primary/lab.net-reverse.db
```

Validate
--------

Forward lookups:

```console
# drill dns.lab.net
;; ->>HEADER<<- opcode: QUERY, rcode: NOERROR, id: 47488
;; flags: qr aa rd ra ; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0
;; QUESTION SECTION:
;; dns.lab.net.	IN	A

;; ANSWER SECTION:
dns.lab.net.	3600	IN	A	10.0.1.2

;; AUTHORITY SECTION:

;; ADDITIONAL SECTION:

;; Query time: 0 msec
;; SERVER: 127.0.0.1
;; WHEN: Sat Nov 15 11:05:43 2025
;; MSG SIZE  rcvd: 45
# drill freebsd.org
;; ->>HEADER<<- opcode: QUERY, rcode: NOERROR, id: 7773
;; flags: qr rd ra ; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0
;; QUESTION SECTION:
;; freebsd.org.	IN	A

;; ANSWER SECTION:
freebsd.org.	3532	IN	A	96.47.72.84

;; AUTHORITY SECTION:

;; ADDITIONAL SECTION:

;; Query time: 0 msec
;; SERVER: 127.0.0.1
;; WHEN: Sat Nov 15 11:06:11 2025
;; MSG SIZE  rcvd: 45
```

Reverse lookups:

```console
# drill -x 10.0.1.2
;; ->>HEADER<<- opcode: QUERY, rcode: NOERROR, id: 51164
;; flags: qr aa rd ra ; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0
;; QUESTION SECTION:
;; 2.1.0.10.in-addr.arpa.	IN	PTR

;; ANSWER SECTION:
2.1.0.10.in-addr.arpa.	3600	IN	PTR	dns.lab.net.

;; AUTHORITY SECTION:

;; ADDITIONAL SECTION:

;; Query time: 0 msec
;; SERVER: 127.0.0.1
;; WHEN: Sat Nov 15 11:06:28 2025
;; MSG SIZE  rcvd: 64
# drill -x 1.1.1.1
;; ->>HEADER<<- opcode: QUERY, rcode: NOERROR, id: 18731
;; flags: qr rd ra ; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0
;; QUESTION SECTION:
;; 1.1.1.1.in-addr.arpa.	IN	PTR

;; ANSWER SECTION:
1.1.1.1.in-addr.arpa.	378	IN	PTR	one.one.one.one.

;; AUTHORITY SECTION:

;; ADDITIONAL SECTION:

;; Query time: 425 msec
;; SERVER: 127.0.0.1
;; WHEN: Sat Nov 15 11:06:50 2025
;; MSG SIZE  rcvd: 67
```

SEE ALSO
========

-	[FreeBSD wiki - named.conf](http://www.freebsdwiki.net/index.php/BIND_(configuring))
