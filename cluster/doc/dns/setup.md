NAME
====

**setup** - setup local authoritative DNS

DESCRIPTION
===========

Use a FreeBSD jail to run DNS server.

Bind
----

```console
% doas jexec dns pkg install bind920
```

<details>
<summary>Message from pkg</summary>

```
Message from bind920-9.20.13:

--
BIND requires configuration of rndc, including a "secret"
key.  The easiest, and most secure way to configure rndc is
to run 'rndc-confgen -a' to generate the proper conf file,
with a new random key, and appropriate file permissions.

The /usr/local/etc/rc.d/named script will do that for you.

If using syslog to log the BIND9 activity, and using a
chroot'ed installation, you will need to tell syslog to install
a log socket in the BIND9 chroot by running:

  # sysrc altlog_proglist+=named

And then restarting syslogd with: service syslogd restart
```

</details>

Enable the service:

```console
s jexec dns sysrc -f /etc/rc.conf.d/named named_enable=yes
named_enable:  -> yes
```

Configuration
-------------

Run DNS on local address only:

```
// file: /usr/local/etc/namedb/named.conf
options {
  listen-on { 127.0.0.1; 10.0.1.91; };
}
```

Restrict DNS clients to local network:

```
// file: /usr/local/etc/namedb/named.conf
acl jail-lo { 10.0.1.0/24; };
options {
  allow-query { 127.0.0.1; jail-lo; };
}
```

Do not use slaves:

```
// file: /usr/local/etc/namedb/named.conf
options {
  allow-transfer  { "none"; };
}
```

Forward unknown DNS requests to the default gateway:

```
// file: /usr/local/etc/namedb/named.conf
options {
  forwarders  { 192.168.1.1; };
}
```

We'll store zones in separate files:

```
// file: /usr/local/etc/namedb/named.conf
include "/usr/local/etc/namedb/zones.conf.d/lab.net.conf";
```

Use local DNS server.

```console
% cat /etc/resolv.conf
# Generated by resolvconf
search lab.net
nameserver 127.0.0.1
```

Zone lab.net
------------

```
// file: usr/local/etc/namedb/zones.conf.d/lab.net.conf
zone "lab.net" IN {
  type master;
  file "/usr/local/etc/namedb/primary/lab.net-forward.db";
  allow-update { none; };
};
zone "1.0.10.in-addr.arpa" IN {
  type master;
  file "/usr/local/etc/namedb/primary/lab.net-reverse.db";
  allow-update { none; };
};
```

Forward mapping:

```
; file: /usr/local/etc/namedb/primary/lab.net-forward.db
$TTL  1h
@       IN      SOA     dns.lab.net. root.dns.lab.net. (
                        ;; [YYYYMMDDnn] (update date + number)
                        2025100501; Serial
                        1h;   Refresh
                        15m;    Retry
                        1w;   Expiry
                        1d;   Minimum
)

; Name server
      IN  NS  dns.lab.net.
      IN  A   10.0.1.91

; Servers
dns   IN  A 10.0.1.91
```

Reverse mapping:

```
; file:
$TTL  1h
@       IN      SOA     lab.net. root.lab.net. (
                        ;; [YYYYMMDDnn] (update date + number)
                        2025100501; Serial
                        1h;   Refresh
                        15m;    Retry
                        1w;   Expiry
                        1d;   Minimum
)

; Name server
      IN  NS  dns.lab.net.
      IN  A   10.0.1.91

; Servers
91    IN  PTR dns.lab.net.
```

Validation
----------

Start DNS:

```console
# service named start
Starting named.
```

Validate forward lookups:

```console
% dig dns.lab.net

; <<>> DiG 9.20.13 <<>> dns.lab.net
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 57223
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: 9f2833a5ec7f000f0100000068e29bce811d2b1a22c63fab (good)
;; QUESTION SECTION:
;dns.lab.net.     IN  A

;; ANSWER SECTION:
dns.lab.net.    3600  IN  A 10.0.1.91

;; Query time: 0 msec
;; SERVER: 127.0.0.1#53(127.0.0.1) (UDP)
;; WHEN: Sun Oct 05 11:24:46 CDT 2025
;; MSG SIZE  rcvd: 84
% dig freebsd.org

; <<>> DiG 9.20.13 <<>> freebsd.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 61939
;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: 8a565b03e2f364600100000068e29bea439e4bd9c791cb28 (good)
;; QUESTION SECTION:
;freebsd.org.     IN  A

;; ANSWER SECTION:
freebsd.org.    3600  IN  A 96.47.72.84

;; Query time: 130 msec
;; SERVER: 127.0.0.1#53(127.0.0.1) (UDP)
;; WHEN: Sun Oct 05 11:25:14 CDT 2025
;; MSG SIZE  rcvd: 84
```

Validate reverse lookups:

```console
% dig -x 10.0.1.91

; <<>> DiG 9.20.13 <<>> -x 10.0.1.91
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 31107
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: d15a3c19b635b8a80100000068e29c0de19c0ecdee9fec17 (good)
;; QUESTION SECTION:
;91.1.0.10.in-addr.arpa.    IN  PTR

;; ANSWER SECTION:
91.1.0.10.in-addr.arpa. 3600  IN  PTR dns.lab.net.

;; Query time: 0 msec
;; SERVER: 127.0.0.1#53(127.0.0.1) (UDP)
;; WHEN: Sun Oct 05 11:25:49 CDT 2025
;; MSG SIZE  rcvd: 104
% dig -x 1.1.1.1

; <<>> DiG 9.20.13 <<>> -x 1.1.1.1
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 36782
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: 8dba48aa9230e82c0100000068e29c31497c2c2cf91e64c9 (good)
;; QUESTION SECTION:
;1.1.1.1.in-addr.arpa.    IN  PTR

;; ANSWER SECTION:
1.1.1.1.in-addr.arpa. 1262  IN  PTR one.one.one.one.

;; Query time: 261 msec
;; SERVER: 127.0.0.1#53(127.0.0.1) (UDP)
;; WHEN: Sun Oct 05 11:26:25 CDT 2025
;; MSG SIZE  rcvd: 106
```

SEE ALSO
========

-	[FreeBSD wiki - named.conf](http://www.freebsdwiki.net/index.php/BIND_(configuring))
