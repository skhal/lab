NAME
====

**jail-ubuntu** - create a Ubuntu jail

Bootstrap
=========

Start from Ubuntu template

```console
% % zfs list -t snapshot zroot/jail/template/Ubuntu-22.04
NAME                                    USED  AVAIL  REFER  MOUNTPOINT
zroot/jail/template/Ubuntu-22.04@p0.0     8K      -  1.04G  -
% zfs clone zroot/jail/template/Ubuntu-22.04@p0.0 zroot/jail/container/jammy
```

Use `rc.jail` on the host environment to mana epair(4) for the jail. Propagate mount points, created by `linux` service, from the host to jailed environment under `/compat/<distribution>`:

```
% cat /etc/jail.conf.d/jammy.conf
jammy {
  $id = "12";

  $bridge0 = "bridge0";
  $bridge0_ip = "${bridge0}:192.168.1.${id}/24";

  $bridge1 = "bridge1";
  $bridge1_ip = "${bridge1}:10.0.1.${id}/24";

  $bridges = "${bridge0} ${bridge1}";
  $bridgeips = "${bridge0_ip} ${bridge1_ip}";

  host.hostname = "${name}.lab.net";
  path = "/jail/container/${name}";

  depend  = "dns";
  depend += "ldap";

  vnet;

  # keep-sorted start
  allow.mount.devfs;
  allow.mount.fdescfs;
  allow.mount.linprocfs;
  allow.mount.linsysfs;
  allow.mount.procfs;
  allow.mount.tmpfs;
  allow.mount;
  allow.raw_sockets;
  # keep-sorted end

  mount += "/home     $path/compat/jammy/home    nullfs    rw 0 0";
  mount += "devfs     $path/compat/jammy/dev     devfs     rw 0 0";
  mount += "fdescfs   $path/compat/jammy/dev/fd  fdescfs   rw,linrdlnk 0 0";
  mount += "linprocfs $path/compat/jammy/proc    linprocfs rw 0 0";
  mount += "linsysfs  $path/compat/jammy/sys     linsysfs  rw 0 0";
  mount += "tmpfs     $path/compat/jammy/dev/shm tmpfs     rw,size=1g,mode=1777 0 0";
  mount.devfs;
  devfs_ruleset = 5;

  enforce_statfs = 1;

  exec.clean;
  exec.consolelog = "/var/log/jail_${name}.log";

  exec.prestart = "/bin/sh /usr/local/etc/rc.jail prestart ${name} ${bridges}";
  exec.created  = "/bin/sh /usr/local/etc/rc.jail created ${name} ${bridgeips}";
  exec.start    = "/bin/sh /etc/rc";

  exec.stop     = "/bin/sh /etc/rc.shutdown";
  exec.poststop = "/bin/sh /usr/local/etc/rc.jail poststop ${name} ${bridges}";
}
```

Start new jail:

```
% doas service jail start jammy
```

Auto-start:

```
# sysrc -f /etc/rc.conf.d/jail jail_list+=jammy
```

Verify:

```console
% doas jexec jammy ifconfig -a -g epair
epair6b: flags=1008843<UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST,LOWER_UP> metric 0 mtu 1500
	description: jail:jammy:bridge0
	options=8<VLAN_MTU>
	ether 02:55:ef:72:1f:0b
	inet 192.168.1.12 netmask 0xffffff00 broadcast 192.168.1.255
	groups: epair
	media: Ethernet 10Gbase-T (10Gbase-T <full-duplex>)
	status: active
	nd6 options=29<PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL>
epair7b: flags=1008843<UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST,LOWER_UP> metric 0 mtu 1500
	description: jail:jammy:bridge1
	options=8<VLAN_MTU>
	ether 02:54:f8:a8:4a:0b
	inet 10.0.1.12 netmask 0xffffff00 broadcast 10.0.1.255
	groups: epair
	media: Ethernet 10Gbase-T (10Gbase-T <full-duplex>)
	status: active
	nd6 options=29<PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL>
% doas jexec jammy route get 0
   route to: default
destination: default
       mask: default
    gateway: unifi.localdomain
        fib: 0
  interface: epair6b
      flags: <UP,GATEWAY,DONE,STATIC>
 recvpipe  sendpipe  ssthresh  rtt,msec    mtu        weight    expire
       0         0         0         0      1500         1         0
% doas jexec jammy nc -uv 192.168.1.1 53
Connection to 192.168.1.1 53 port [udp/domain] succeeded!
^C
% doas jexec jammy ping -c 1 freebsd.org
PING freebsd.org (96.47.72.84): 56 data bytes
64 bytes from 96.47.72.84: icmp_seq=0 ttl=51 time=32.982 ms

--- freebsd.org ping statistics ---
1 packets transmitted, 1 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 32.982/32.982/32.982/0.000 ms
```

Configuration
=============

Use [`local`](https://github.com/freebsd/freebsd-src/blob/5f1f7d8457d4fc28c6cff7e26a629a2d6ee3fc61/libexec/rc/rc.d/local) service to start and stop Linux services.

Resolver
--------

Point to local DNS resolver:

```console
% doas jexec jammy chroot /compat/jammy cat /etc/resolv.conf
# Generated by resolvconf
search lab.net
nameserver 10.0.1.2
```

Verify:

```console
% doas jexec jammy chroot /compat/jammy drill dns.lab.net
;; ->>HEADER<<- opcode: QUERY, rcode: NOERROR, id: 51746
;; flags: qr aa rd ra ; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0
;; QUESTION SECTION:
;; dns.lab.net.	IN	A

;; ANSWER SECTION:
dns.lab.net.	3600	IN	A	10.0.1.2

;; AUTHORITY SECTION:

;; ADDITIONAL SECTION:

;; Query time: 0 msec
;; SERVER: 10.0.1.2
;; WHEN: Tue Nov 18 10:20:59 2025
;; MSG SIZE  rcvd: 45
```

Name Service Switch (NSS)
-------------------------

Ensure LDAP server is reachable (use `ldap.lab.net` in URI). Install LDAP tools:

```console
% doas jexec jammy chroot /compat/jammy apt install ldap-utils
% doas jexec jammy fetch -o /compat/jammy/tmp https://raw.githubusercontent.com/skhal/lab/refs/heads/main/cluster/doc/jail/data/ldap.conf.diff
% doas jexec jammy chroot /compat/jammy patch -i /tmp/ldap.conf.diff /etc/ldap/ldap.conf
```

Verify:

```console
% doas jexec jammy chroot /compat/jammy ldapsearch -x -s base
# extended LDIF
#
# LDAPv3
# base <dc=lab,dc=net> (default) with scope baseObject
# filter: (objectclass=*)
# requesting: ALL
#

# lab.net
dn: dc=lab,dc=net
dc: lab
objectClass: dcObject
objectClass: organization
description: Research & Development lab
o: Research Lab

# search result
search: 2
result: 0 Success

# numResponses: 2
# numEntries: 1
```

Add `libnss-ldapd` with the following configuration:

-	Host: `ldap.lab.net`
-	Base: `dc=lab,dc=net`
-	Services: `passwd` and `group`
-	TLS: none

Install:

```console
% doas jexec jammy chroot /compat/jammy apt install libnss-ldapd
```

Enable nslcd(8) service:

```console
% doas jexec jammy fetch -o /tmp https://raw.githubusercontent.com/skhal/lab/refs/heads/main/cluster/doc/jail/data/nslcd/rc.local
% mv -vn /tmp/rc.local /etc/
% doas jexec jammy fetch -o /tmp https://raw.githubusercontent.com/skhal/lab/refs/heads/main/cluster/doc/jail/data/nslcd/rc.shutdown.local
% mv -vn /tmp/rc.shutdown.local /etc/
```

Restart the jail. Verify:

```console
% doas jexec jammy sockstat -lu
USER     COMMAND    PID   FD  PROTO  LOCAL ADDRESS         FOREIGN ADDRESS
106      nslcd      56773 5   stream /var/run/nslcd/socket
root     syslogd    49216 5   dgram  /var/run/log <-
root     syslogd    49216 6   dgram  /var/run/logpriv
% doas jexec jammy chroot /compat/jammy service --status-all |& grep nslcd
 [ + ]  nslcd
% doas jexec jammy chroot /compat/jammy getent passwd op
op:*:1000:1000:Operator:/home/op:/bin/tcsh
```

Pluggable Authentication Modules (PAM)
--------------------------------------

```console
% doas jexec jammy chroot /compat/jammy apt install libpam-ldapd
```

Secure Shell (SSH)
------------------

```console
% doas jexec jammy chroot /compat/jammy apt install openssh-server
```

Listen on local address, allow only users from `ssh` group:

```console
% doas jexec jammy chroot /compat/jammy su -
root@jail:jammy :~ # cat /etc/ssh/sshd_config.d/lab.net.conf
ListenAddress=192.168.1.12
AllowGroups=ssh
```

Enable the service:

```console
% doas jexec jammy head /etc/rc.{,shutdown.}local
==> /etc/rc.local <==
chroot /compat/jammy /usr/sbin/service nslcd start
chroot /compat/jammy /usr/sbin/service ssh start

==> /etc/rc.shutdown.local <==
chroot /compat/jammy /usr/sbin/service ssh stop
chroot /compat/jammy /usr/sbin/service nslcd stop
```

**Warning**: make sure to start/stop `ssh` after/before `nslcd`. SSH uses LDAP to authenticate users.

Verify:

```console
% doas jexec jammy sockstat -l4
USER     COMMAND    PID   FD  PROTO  LOCAL ADDRESS         FOREIGN ADDRESS
root     sshd       59004 3   tcp4   192.168.1.12:22       *:*
% doas jexec jammy chroot /compat/jammy service --status-all |& grep ssh
 [ + ]  ssh
% ssh op@jammy.lab.net hostname
op@jammy.lab.net's password:
jammy.lab.net
```

**Warning**: SSH may refuse credentials if user login shell is not installed.

Sudo
----

`sudo-ldap` manipulates `sudo` package. The latter one can only be re-installed or removed if the root password is set:

```console
% doas jexec jammy chroot /compat/jammy sudo passwd
```

Now, install `sudo-ldap`:

```console
% doas jexec jammy chroot /compat/jammy apt install sudo-ldap
```

Sudo stores LDAP settings in `/etc/sudo-ldap.conf`. Use following configuration:

-	URI: `ldap://ldap.lab.net`
-	Base: `dc=lab,dc=net`
-	Sudoers: `sudoers_base ou=sudoers,dc=lab,dc=net`
-	TLS: none

Verify:

```console
% doas jexec jammy chroot /compat/jammy su - skhalatyan -c 'sudo -S -l'
[sudo] password for skhalatyan:
Matching Defaults entries for skhalatyan on jammy:
    R.E.D.A.C.T.E.D

User skhalatyan may run the following commands on jammy:
    (root) R.E.D.A.C.T.E.D
```

Note: `sudoCommand` field in `cn=%sudoer,ou=sudoers,dc=lab,dc=net` entity lists sudo-enabled commands.

SEE ALSO
========

-	https://github.com/freebsd/freebsd-src/blob/5f1f7d8457d4fc28c6cff7e26a629a2d6ee3fc61/libexec/rc/rc.d/local
